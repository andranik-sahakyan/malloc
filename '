#include "icsmm.h"
#include "macros.h"
#include "helpers.h"

uint64_t* init_page() {
	uint64_t* brk = (uint64_t*) ics_get_brk();	
	brk = (uint64_t*) ics_inc_brk();
	if (*brk == -1) return NULL; 
	
	// Prologue
	((ics_header*)(brk))->block_size = 0x0001;

	// Epilogue
	((ics_header*)(((char*) brk) + PSIZE - WSIZE))->block_size = 0x0001;		
	
	// Create first block
	ics_free_header* first_block = ((ics_free_header*)(((char*) brk) + WSIZE)); 
	first_block->header.unused = 0xaaaaaaaa;
	first_block->header.block_size = PSIZE - (2 * WSIZE);
	first_block->prev = &(first_block->header);
	first_block->next = (ics_free_header*) first_block->header;

	((ics_footer*)(((char*) brk) + PSIZE - 2 * WSIZE))->unused = 0xaaaaaaaaaaaa;
	((ics_footer*)(((char*) brk) + PSIZE - 2 * WSIZE))->block_size = PSIZE - (2 * WSIZE);
	
	freelist_head = (ics_free_header*)(((char*) brk) + WSIZE);
	freelist_next = (ics_free_header*)(((char*) brk) + WSIZE);

	return (uint64_t*)(((char*) brk) + 2 * WSIZE);
}
